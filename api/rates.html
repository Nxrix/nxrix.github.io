<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Rates</title>
</head>

<style>

@font-face {
  font-family: "sfr";
  src: url("https://nxrix.github.io/assets/fonts/SFRounded/subset-SFRounded-Semibold.ttf");
}

:root {
  --bg0: #000;
  --fg0: #fff;

  --bg1: #111;
  --fg1: #eee;

  --bg2: #222;
  --fg2: #ddd;

  --bg3: #333;
  --fg3: #ccc;
  
  --bg4: #444;
  --fg4: #bbb;
  
  --bg5: #555;
  --fg5: #aaa;
  
  --bg6: #666;
  --fg6: #999;

  --grey: #888888;
  --green: #16c784;
  --red: #ea3943;
}

/*:root {
  --fg0: #000;
  --bg0: #fff;

  --fg1: #111;
  --bg1: #eee;

  --fg2: #222;
  --bg2: #ddd;

  --fg3: #333;
  --bg3: #ccc;
  
  --fg4: #444;
  --bg4: #bbb;
  
  --fg5: #555;
  --bg5: #aaa;

  --fg6: #666;
  --bg6: #999;

  --grey: #888888;
  --green: #16c784;
  --red: #ea3943;
}*/

::-webkit-scrollbar {
  width: 0px;
  height: 0px;
}
::-webkit-scrollbar-track {
  background-color: #0000;
}
::-webkit-scrollbar-thumb {
  background-color: #0000;
}
::-webkit-scrollbar-thumb:hover {
  background-color: #0000;
}
::-webkit-scrollbar-corner {
  background-color: #0000;
}

html, body {
  background-color: var(--bg0);
  color: var(--fg1);
  font-family: "sfr";
  width: 100%;
  height: 100%;
  margin: 0;
}

h1, h2, h3 {
  margin: 0;
}

.header {
  display: flex;
  flex-direction: row;
  align-items: center;
  box-sizing: border-box;
  padding: 1.5rem 0.5rem 0rem 0.5rem;
}

#grid {
  display: grid;
  grid-gap: 0.5rem;
  grid-template-columns: repeat(auto-fill,minmax(160px,1fr));
  box-sizing: border-box;
  padding: 0.5rem;
  padding-bottom: calc(0.5rem + 80px);
}

#grid > div {
  position: relative;
  opacity: 1;
  transform: scale(1);
  transition: transform 0.25s ease, opacity 0.25s ease;
}

#grid > div.new {
  opacity: 0;
  transform: scale(0.8);
}

#grid > div.old {
  position: absolute !important;
  opacity: 0;
  transform: scale(0.8);
}

#list, #items {
  background-color: var(--bg1);
  /*backdrop-filter: url(#filter);*/
  color: var(--fg2);
  user-select: none;
  outline: 0.1rem solid var(--bg2);
  display: flex;
  flex-direction: column;
  position: fixed;
  width: calc(100% - 1rem);
  max-width: 500px;
  height: calc(100% - 48px - 1.5rem);
  bottom: calc(48px + 0.5rem + 0.5rem);
  margin: 0 0.5rem;
  left: calc(50% - 0.5rem);
  border-radius: 24px;
  z-index: 3;
  box-sizing: border-box;
  overflow-x: hidden;
  overflow-y: auto;
  opacity: 0;
  transform: translateX(-50%) scale(0.8);
  pointer-events: none;
  transition: transform 0.25s ease, opacity 0.25s ease;
}

#list.active, #items.active {
  opacity: 1;
  transform: translateX(-50%) scale(1);
  pointer-events: auto;
}

#list > div {
  display: flex;
  flex-direction: row;
  justify-content: space-between;
  align-items: center;
  padding: 16px;
}

#controls {
  /*background-color: var(--bg1);*/
  backdrop-filter: url(#filter);
  outline: 0.1rem solid var(--bg2);
  position: fixed;
  width: calc(100% - 1rem);
  max-width: 500px;
  height: 48px;
  padding: 4px 8px;
  bottom: 0.5rem;
  margin: 0 0.5rem;
  left: calc(50% - 0.5rem);
  transform: translateX(-50%) scale(0.8);
  border-radius: 24px;
  z-index: 3;
  box-sizing: border-box;
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--fg6);
  opacity: 0;
  pointer-events: none;
  transition: transform 0.25s ease, opacity 0.25s ease;
}

#controls.active {
  opacity: 1;
  transform: translateX(-50%) scale(1);
  pointer-events: auto;
}

#controls * {
  user-select: none;
}

#add, #menu {
  height: 100%;
  aspect-ratio: 1;
  flex-shrink: 0;
}
#add svg , #menu svg {
  width: 100%;
  height: 100%;
  padding: 6px;
  box-sizing: border-box;
}
#date {
  font-size: 0.8rem;
  text-align: center;
  flex: 1;
}

#items {
  padding: 16px;
}

#items .group div > div {
  padding: 4px 8px;
}

</style>

<body>

  <div class="header">
    <h1>Absolute Cinema</h1>
    <span id="date2" style="display:none;"></span>
  </div>

  <div id="grid"></div>

  <div id="controls">
    <div id="add">
      <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="currentColor"><path d="M440-440H200v-80h240v-240h80v240h240v80H520v240h-80v-240Z"/></svg>
    </div>
    <div id="date"></div>
    <div id="menu">
      <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="currentColor"><path d="M240-400q-33 0-56.5-23.5T160-480q0-33 23.5-56.5T240-560q33 0 56.5 23.5T320-480q0 33-23.5 56.5T240-400Zm240 0q-33 0-56.5-23.5T400-480q0-33 23.5-56.5T480-560q33 0 56.5 23.5T560-480q0 33-23.5 56.5T480-400Zm240 0q-33 0-56.5-23.5T640-480q0-33 23.5-56.5T720-560q33 0 56.5 23.5T800-480q0 33-23.5 56.5T720-400Z"/></svg>
    </div>
  </div>

  <div id="list"></div>
  <div id="items"></div>
  
  <svg style="display: none">
    <filter id="filter" color-interpolation-filters="sRGB" filterUnits="objectBoundingBox" primitiveUnits="userSpaceOnUse">
      <feTurbulence type="fractalNoise" baseFrequency="0.01 0.01" numOctaves="1" seed="5" result="turbulence" />
      <feComponentTransfer in="turbulence" result="map">
        <feFuncR type="gamma" amplitude="1" exponent="10" offset="0.5" />
        <feFuncG type="gamma" amplitude="0" exponent="1" offset="0" />
        <feFuncB type="gamma" amplitude="0" exponent="1" offset="0.5" />
      </feComponentTransfer>
      <feDisplacementMap in="SourceGraphic" in2="turbulence" scale="128" xChannelSelector="R" yChannelSelector="G" x="0%" y="0%" width="100%" height="100%" result="displacementMap" />
      <feGaussianBlur stdDeviation="8" x="0%" y="0%" width="100%" height="100%" in="displacementMap" edgeMode="none" result="blur" />
    </filter>
  </svg>

</body>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.6/Sortable.min.js"></script>
<script>

const format = (value,suffix,d=100) => {
  return (Math.round(value*d)/d).toLocaleString("en-US")+suffix;
};

const format_num = (n) => {
  if (n>=1_000_000_000) {
    return format(n/1_000_000_000,"T");
  } else if (n>=1_000_000) {
    return format(n/1_000_000,"M");
  } else if (n>=1_000) {
    return format(n,"",1);
  } else if (n>=100) {
    return format(n,"",10);
  } else if (n>=10) {
    return format(n,"",100);
  } else if (n>=1) {
    return format(n,"",1000);
  } else {
    return n.toLocaleString("en-US");
  }
};

const format_num1 = (n) => {
  if (n>=1_000_000_000) {
    return format(n/1_000_000_000,"T");
  } else if (n>=1_000_000) {
    return format(n/1_000_000,"M");
  } else if (n>=1_000) {
    return format(n/1_000,"K");
  } else {
    return n.toLocaleString("en-US");
  }
};

const html2str = (str) => {
  return String(str)
    .replace(/&/g,"&amp;")
    .replace(/</g,"&lt;")
    .replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;")
    .replace(/'/g,"&#39;");
}

const create_tile = (i) => {
  const show_usd = 1;
  i.change = Math.round(i.change*100)/100;
  const usd = (i.code=="xau"||i.code=="xag")?window.usd:window.usdt;
  if (!show_usd&&i.base=="usd") {
    i.change = Math.round(i.change*usd);
  }
  return `
  <div title="${i.name}" style="
    display: inline-flex;
    flex-direction: column;
    align-items: start;
    width: 100%;
    font: 400 0.75rem sfr;
  ">
  
    <div style="
      background-color: var(--bg1);
      outline: 0.1rem solid var(--bg2);
      outline-offset: -0.1rem;
      position: relative;
      width: 100%;
      border-radius: 16px;
      box-sizing: border-box;
      padding-top: calc(100%/8*7);
    ">

      <div style="
        background-color: var(--bg0);
        position: absolute;
        overflow: hidden;
        top: 0.75rem;
        left: 0.75rem;
        width: 32px;
        height: 32px;
        border-radius: 50%;
      ">
        ${i.icon}
      </div>

      <div style="
        position: absolute;
        top: 0.75rem;
        right: 0.75rem;
        text-align: right;
        max-width: 65%;
      ">
        <div style="
          font-weight: 600;
          font-size: 1rem;
          line-height: 1em;
          word-wrap: break-word;
        ">
          ${i.name}
        </div>
        <div style="
          margin-top: 0.1rem;
          font-size: 0.75rem;
          color: var(--fg5);
          line-height: 1em;
        ">
          ${i.slug.toUpperCase()}
        </div>
      </div>

      <div style="
        position: absolute;
        bottom: 0.75rem;
        left: 0.75rem;
        font-weight: 700;
        font-size: 1.5rem;
      ">
        ${show_usd?
        `${i.base=="usd"?"$":""}${format_num(i.price)}`:
        `${format_num(Math.round(i.price*(i.base=="usd"?usd:1)))}`
        }
      </div>
      
      ${
      
      !show_usd&&i.base=="usd"?`
      <div style="
        position: absolute;
        bottom: 0.75rem;
        right: 0.75rem;
        color: var(--bg5);
        font-weight: 700;
        font-size: 0.8rem;
      ">
        ${i.base=="usd"?
        `$${format_num1(i.price)}`:
        `$${format_num1(i.price/usd)}`
        }
      </div>
      `:(i.base=="usd"&&0?`
      <div style="
        position: absolute;
        bottom: 0.75rem;
        right: 0.75rem;
        color: var(--bg5);
        font-weight: 700;
        font-size: 0.8rem;
      ">
        ${format_num1(i.price*usd)}
      </div>
      `:"")

      }

      <div style="
        position: absolute;
        bottom: 2.5rem;
        left: 0.75rem;
        font-weight: 600;
        font-size: 0.85rem;
        color: ${i.change==0?"var(--grey)":i.change>0?"var(--green)":"var(--red)"};
      ">
        ${i.change==0?"~":i.change>0?"↑":"↓"}${format_num1(Math.abs(i.change))}
      </div>

    </div>

  </div>`;
}

const create_tile_element = (i) => {
  const temp = document.createElement("div");
  temp.innerHTML = create_tile(i);
  const e = temp.firstElementChild;
  e.dataset.slug = i.slug;
  return e;
}

const default_items = [
  "usd",
  /*"usdt",
  "btc",
  "eth",
  "ton",
  "xau",
  "xag",
  "18kgold",
  "azadi",
  "half",
  "quarter",
  "gram",
  "mithqal",
  "emami",*/
];

/*
  unused
  "sand",
  "zen",
  "axs",
  "eos",
  "flow",
  "mana",
  "storj",
  "bat",
  "lrc",
  "cvc",
  "enj",
  "chz",
  "gala",
  "one",
*/

const item_groups = {
  trending: [
    "usd",
    "usdt",
    "18kgold",
    "azadi",
    "btc"
  ],
  fiat: [
    "usd",
    "kwd",
    "bhd",
    "omr",
    "gbp",
    "chf",
    "eur",
    "sgd",
    "cad",
    "jpy",
    "aud",
    "azn",
    "nzd",
    "gel",
    "tmt",
    "qar",
    "aed",
    "sar",
    "amd",
    "myr",
    "brl",
    "dkk",
    "cny",
    "hkd",
    "tjs",
    "sek",
    "nok",
    "krw",
    "iqd",
    "thb",
    "try",
    "afn",
    "rub",
    "kgs",
    "inr",
    "syp",
    "pkr",
    "ars"
  ],
  metal: [
    "xau",
    "xag",
    "18kgold",
    "azadi",
    "half",
    "quarter",
    "gram",
    "mithqal",
    "emami",
  ],
  crypto: [
    "btc",
    "eth",
    "xrp",
    "usdt",
    "bnb",
    "sol",
    "doge",
    "trx",
    "ada",
    "link",
    "xlm",
    "avax",
    "ltc",
    "ton",
    "not",
    "dot",
    "uni",
    "aave",
    "near",
    "zec",
    "fil",
    "cake",
    "grt",
    "xtz"
  ]
}

const list_items = JSON.parse(localStorage.getItem("list_items"))||default_items;

const update_grid = (items) => {
  const gridEl = grid;
  const oldRects = new Map();
  Array.from(gridEl.children).forEach(el => {
    oldRects.set(el.dataset.slug, el.getBoundingClientRect());
  });
  const existing = new Map(
    Array.from(gridEl.children).map(el => [el.dataset.slug, el])
  );
  const fragment = document.createDocumentFragment();
  items.forEach(i => {
    let el = existing.get(i.slug);
    if (!el) {
      el = create_tile_element(i);
      el.classList.add("new");
    }
    fragment.appendChild(el);
  });
  gridEl.innerHTML = "";
  gridEl.appendChild(fragment);
  Array.from(gridEl.children).forEach(el => {
    const old = oldRects.get(el.dataset.slug);
    if (!old) return;
    const newRect = el.getBoundingClientRect();
    const dx = old.left - newRect.left;
    const dy = old.top - newRect.top;
    el.style.transform = `translate(${dx}px,${dy}px)`;
    el.style.transition = "none";
    requestAnimationFrame(() => {
      el.style.transition = "all 0.25s ease";
      el.style.transform = "translate(0,0)";
    });
  });
  requestAnimationFrame(() => {
    requestAnimationFrame(() => {
      gridEl.querySelectorAll(".new").forEach(el => el.classList.remove("new"));
    });
  });
}

const render_list = () => {
  list.innerHTML = "";
  list_items.forEach((i,n) => {
    const m = window.data.prices.find(e=>e.slug==i);
    const e = document.createElement("div");
    e.innerHTML = `
      <div>${m.name}</div>
      <div style="display:flex;">
        <div onclick="list_items.splice(${n},1);render_list();">
          <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="currentColor"><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg>
        </div>
        <div class="drag-handle" style="cursor:grab;margin-left:10px;">
          <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="currentColor"><path d="M160-360v-80h640v80H160Zm0-160v-80h640v80H160Z"/></svg>
        </div>
      </div>`;
    list.appendChild(e);
  });

  items.innerHTML = Object.entries(item_groups).map(([group,slugs]) => {
    const items = slugs
      .filter(slug => !list_items.includes(slug))
      .map(slug => {
        const i = window.data.prices.find(p=>p.slug==slug);
        if (!i) return "";
        return `<div onclick="list_items.push('${i.slug}');render_list();items.classList.toggle('active')">${i.name}</div>`;
      })
      .join("");
    if (!items) return "";
    return `
      <div class="group">
        <h2>${group.substr(0,1).toUpperCase()+group.substr(1)}</h2>
        <br>
        <div>${items}</div>
      </div>
      <br>
    `;
  }).join("");
    
  const l = window.data.prices
    .filter(i=>list_items.includes(i.slug))
    .sort((a,b)=>list_items.indexOf(a.slug)-list_items.indexOf(b.slug));
  update_grid(l);
  localStorage.setItem("list_items",JSON.stringify(list_items));
}

add.onclick = () => {
  if (list.classList.contains("active")) list.classList.remove("active");
  items.classList.toggle("active");
  //list_items.push(select.value);
  //render_list();
}

menu.onclick = () => {
  if (items.classList.contains("active")) items.classList.remove("active");
  list.classList.toggle("active");
}

window.onload = async () => {

  const yesterday = await (async()=>{
    try {
      let lastCommit = localStorage.getItem("last_commit") || "";
      let data1;
      if (
        lastCommit &&
        new Date().getTime() -
          24 * 60 * 60 * 1000 -
          parseInt(lastCommit.split(",")[0], 10) <
          60 * 11000
      ) {
        const commitSha = lastCommit.split(",")[1];
        data1 = await (
          await fetch(
            `https://raw.githubusercontent.com/CertMusashi/Chand-api/${commitSha}/arz.json`
          )
        ).json();
      } else {
        const yesterday = new Date(new Date().getTime() - 24 * 60 * 60 * 1000);
        const until = new Date(
          yesterday.getTime() + 10 * 60 * 1000
        ).toISOString();
        const commits = await (
          await fetch(
            `https://api.github.com/repositories/930913626/commits?path=arz.json&until=${until}&per_page=1`
          )
        ).json();
        for (const commit of commits) {
          localStorage.setItem(
            "last_commit",
            `${yesterday.getTime()},${commit.sha}`
          );
          data1 = await (
            await fetch(
              `https://raw.githubusercontent.com/CertMusashi/Chand-api/${commit.sha}/arz.json`
            )
          ).json();
        }
      }

      return {
        date: html2str(data1.date),
        prices: data1.currencies.map(({ code, price }) => {
          return { code: html2str(code), price: Number(price)||0 };
        })
      };
    } catch (err) {
      return null;
    }
  })();
  
  const data = await (async()=>{
    const data = await fetch(
      "https://raw.githubusercontent.com/CertMusashi/Chande-api/refs/heads/main/arz.json"
    ).then((r) => r.json());
    const f = [
      "usd_xau",
      "xag",
      "btc",
      "eth",
      "ton",
      "xrp",
      "bnb",
      "shib",
      "ada",
      "doge",
      "not",
      "sol",
      "trx",
      "cake",
      "avax",
      "dot",
      "link",
      "ltc",
      "pepe",
      "uni",
      "xlm",
      "fil",
      "near",
      "eos",
      "aave",
      "grt",
      "xtz",
      "flow",
      "sand",
      "mana",
      "axs",
      "chz",
      "enj",
      "zec",
      "gala",
      "lrc",
      "bat",
      "one",
      "zen",
      "cvc",
      "storj"
    ];
    const slugs = {
      "usd_xau": ["xau", "Gold"],
      "xag": ["xag", "Silver"],
      "18ayar": ["18kgold", "18 Karat Gold"],
      "bahar": ["azadi", "Azadi"],
      "nim": ["half", "Half"],
      "rob": ["quarter", "Quarter"],
      "gram": ["gram", "Gram"],
      "abshodeh": ["mithqal", "Mithqal"],
      "sekkeh": ["emami", "Emami"],
      "eur": ["eur", "Euro"],
      "bhd": ["bhd", "Bahraini Dinar"]
    };
    const g = `<div style="background:radial-gradient(circle at 60% 40%,#fc0,#954);width:100%;height:100%;"></div>`;
    const s = "<div style=\"background:radial-gradient(circle at 60% 40%,#ddd,#667);width:100%;height:100%;\"></div>";
    const icons = {
      "usd_xau": g,
      "18ayar": g,
      "bahar": g,
      "nim": g,
      "rob": g,
      "gram": g,
      "abshodeh": g,
      "sekkeh": g,
      "xag": s
    };
    const prices = data.currencies
      .map(i => {
        return {
          code: html2str(i.code),
          name: html2str(i.name),
          price: Number(i.price)||0,
          icon: html2str(i.icon),
          en: html2str(i.en)
        };
      })
      .map(i => {
        const r = slugs[i.code] || [];
        const y = yesterday.prices.find((y) => y.code == i.code) || {};
        return {
          slug: r[0] || i.code,
          name: (r[1] || i.en).replace(/\b\w/g, (c) => c.toUpperCase()),
          price: i.price,
          change: y.price ? i.price - y.price : null,
          base: f.includes(i.code) ? "usd" : "irt",
          icon:
            icons[i.code] || `<img src="${i.icon}" style="width:100%;height:100%;">`,
          g: icons?.[i.code] ? true : false
        };
      })
      .filter(i=>i.price > 0.001)
      .filter(i=>i.slug.split("-").length<2)
      .sort((a, b) => {
        const ai = default_items.indexOf(a.slug);
        const bi = default_items.indexOf(b.slug);
        const aInList = ai !== -1;
        const bInList = bi !== -1;
        if (aInList && bInList) {
          return ai - bi;
        }
        if (aInList) return -1;
        if (bInList) return 1;
        const aIsUsd = a.base.toLowerCase() === "usd";
        const bIsUsd = b.base.toLowerCase() === "usd";
        if (!aIsUsd && bIsUsd) return -1;
        if (aIsUsd && !bIsUsd) return 1;
        return b.price - a.price;
      });

    return {
      date: html2str(data.date),
      prices
    };
  })();

  date.innerHTML = data.date;//`<span style="color:var(--bg3)">${yesterday.date} - </span>${data.date}`;
  
  window.usd = data.prices.find(i=>i.slug=="usd").price;
  window.usdt = data.prices.find(i=>i.slug=="usd").price;
  window.data = data;
  render_list();
  new Sortable(list, {
    animation: 160,
    touchStartThreshold: 0,
    ghostClass: "sortable-ghost",
	  chosenClass: "sortable-chosen",
	  dragClass: "sortable-drag",
    handle: ".drag-handle",
    setData: function (dataTransfer,dragEl) {
		  dataTransfer.setData('Text', dragEl.textContent);
	  },
    onEnd: function(e) {
      const [moved] = list_items.splice(e.oldIndex, 1);
      list_items.splice(e.newIndex,0,moved);
      render_list();
    }
  });
  controls.classList.toggle("active");
}

</script>

</html>
